<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foodle ‚Äî Daily Nutrition Connections</title>
  <meta name="description" content="Foodle: a Connections-style nutrition game. Group foods into 4 correct categories." />
  <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ü•¶</text></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    html, body { height: 100%; }
    body {
      background:
        radial-gradient(1200px 600px at 20% -10%, #dbeafe 0%, rgba(219,234,254,0) 70%),
        radial-gradient(900px 500px at 100% 10%, #e0f2fe 0%, rgba(224,242,254,0) 60%),
        #eef6ff;
    }
    .shake { animation: shake 0.2s linear; }
    @keyframes shake { 0%{transform:translateX(0)}25%{transform:translateX(-2px)}75%{transform:translateX(2px)}100%{transform:translateX(0)} }
    button:disabled { cursor: not-allowed; }
  </style>
</head>
<body class="min-h-screen w-full flex items-center justify-center p-3">
  <div id="root" className="w-full max-w-3xl"></div>

  <script type="text/babel">
    // ===== Utility Functions =====
    function isoDate() {
      return new Date().toISOString().split("T")[0];
    }
    function getDayIndex() {
      const start = new Date("2024-08-01");
      const today = new Date();
      return Math.floor((today - start) / (1000 * 60 * 60 * 24));
    }
    function shuffleArray(arr, seed) {
      const copy = [...arr];
      let m = copy.length, t, i;
      while (m) {
        i = Math.floor(Math.random() * m--);
        t = copy[m];
        copy[m] = copy[i];
        copy[i] = t;
      }
      return copy;
    }
    function flattenPuzzle(p) {
      return p.groups.flatMap(g => g.items.map(item => ({ ...item, group: g.name, color: g.color })));
    }

    // ===== Sample Puzzle Data =====
    const PUZZLES = [
      {
        id: "2025-08-14",
        groups: [
          { name: "High Protein Foods", color: "bg-green-300", items: [
            { id: "chicken", text: "Chicken Breast" },
            { id: "eggs", text: "Eggs" },
            { id: "tuna", text: "Tuna" },
            { id: "tofu", text: "Tofu" }
          ]},
          { name: "High Fiber Foods", color: "bg-yellow-300", items: [
            { id: "beans", text: "Black Beans" },
            { id: "oats", text: "Oats" },
            { id: "broccoli", text: "Broccoli" },
            { id: "chia", text: "Chia Seeds" }
          ]},
          { name: "Healthy Fats", color: "bg-red-300", items: [
            { id: "avocado", text: "Avocado" },
            { id: "almonds", text: "Almonds" },
            { id: "oliveoil", text: "Olive Oil" },
            { id: "salmon", text: "Salmon" }
          ]},
          { name: "Low Calorie Foods", color: "bg-blue-300", items: [
            { id: "cucumber", text: "Cucumber" },
            { id: "celery", text: "Celery" },
            { id: "spinach", text: "Spinach" },
            { id: "berries", text: "Berries" }
          ]}
        ]
      }
    ];

    // ===== Local Storage Keys =====
    const LS_KEYS = {
      progressPrefix: "foodle:progress:",
      finishedPrefix: "foodle:finished:",
      seenPreview: "foodle:seenPreview"
    };

    // ===== Preview Page Component =====
    function PreviewPage({ onStart }) {
      const groups = [
        {
          name: "High-Protein Dairy",
          items: ["Greek Yogurt", "Cottage Cheese", "Skyr", "Fairlife Milk"],
          cls: "bg-yellow-50 border-yellow-200"
        },
        {
          name: "Citrus Fruits",
          items: ["Orange", "Grapefruit", "Lemon", "Lime"],
          cls: "bg-green-50 border-green-200"
        },
        {
          name: "Lean White Fish",
          items: ["Cod", "Haddock", "Tilapia", "Pollock"],
          cls: "bg-blue-50 border-blue-200"
        },
        {
          name: "Sugary Candies",
          items: ["Gummy Bears", "Lollipop", "Licorice", "Caramel"],
          cls: "bg-purple-50 border-purple-200"
        }
      ];

      return (
        <div className="bg-white shadow-lg rounded-xl p-5 w-full">
          <h1 className="text-2xl font-bold mb-4">Welcome to Foodle</h1>
          <p className="text-sm text-gray-600 mb-4">
            Foodle is a daily nutrition game inspired by Connections. Group 16 foods into 4 categories of 4 foods each based on a shared theme.
          </p>
          <div className="rounded-xl border bg-white p-4 mb-4">
            <div className="text-lg font-semibold mb-2">How to Play</div>
            <ol className="list-decimal pl-5 space-y-2 text-sm text-gray-700 mb-4">
              <li>Select <span className="font-semibold">four foods</span> you think belong together by clicking or tapping them.</li>
              <li>Click <span className="font-semibold">Submit</span> to check if your group is correct.</li>
              <li>Find all <span className="font-semibold">four groups</span>. You have <span className="font-semibold">four mistakes</span> before the game ends.</li>
              <li>Groups are color-coded by difficulty: <span className="font-semibold">Yellow</span> (easiest), <span className="font-semibold">Green</span>, <span className="font-semibold">Blue</span>, <span className="font-semibold">Purple</span> (hardest).</li>
              <li><span className="font-semibold">Daily</span> mode locks to today‚Äôs puzzle. Try <span className="font-semibold">Practice</span> mode to play freely.</li>
            </ol>
            <div className="text-lg font-semibold mb-2">Example Groups</div>
            <div className="grid grid-cols-1 gap-3">
              {groups.map((g, i) => (
                <div key={i} className={`rounded-xl p-3 border ${g.cls}`}>
                  <div className="text-sm font-semibold">{g.name}</div>
                  <div className="mt-1 text-sm">{g.items.join(", ")}</div>
                </div>
              ))}
            </div>
          </div>
          <button
            className="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
            onClick={() => {
              localStorage.setItem(LS_KEYS.seenPreview, "1");
              onStart();
            }}
          >
            Start Playing
          </button>
        </div>
      );
    }

    // ===== Main App Component =====
    function App() {
      const dayIndex = getDayIndex() % PUZZLES.length;
      const puzzle = PUZZLES[dayIndex];
      const baseTiles = flattenPuzzle(puzzle);
      const [tiles, setTiles] = React.useState([]);
      const [selected, setSelected] = React.useState([]);
      const [mistakes, setMistakes] = React.useState(0);
      const [lockedGroups, setLockedGroups] = React.useState([]);
      const [guesses, setGuesses] = React.useState([]);
      const [practiceMode, setPracticeMode] = React.useState(false);
      const [showPreview, setShowPreview] = React.useState(localStorage.getItem(LS_KEYS.seenPreview) !== "1");

      const todayISO = isoDate();
      const progressKey = `${LS_KEYS.progressPrefix}${todayISO}`;
      const finishedKey = `${LS_KEYS.finishedPrefix}${todayISO}`;

      // Load puzzle or saved progress
      React.useEffect(() => {
        if (showPreview) return;
        const newSeed = Math.floor(Math.random() * 1e9);
        const stored = localStorage.getItem(progressKey);

        if (stored && !practiceMode) {
          try {
            const data = JSON.parse(stored);
            if (data && data.puzzleId === PUZZLES[dayIndex].id) {
              setSelected([]);
              setMistakes(data.mistakes ?? 0);
              setLockedGroups(data.lockedGroups ?? []);
              setGuesses(data.guesses ?? []);

              const lockedIds = new Set((data.lockedGroups || []).flatMap(g => g.items));
              let rest = baseTiles.filter(t => !lockedIds.has(t.id));

              if (Array.isArray(data.remainingOrder)) {
                const map = new Map(rest.map(t => [t.id, t]));
                rest = data.remainingOrder.map(id => map.get(id)).filter(Boolean);
                const remainingSet = new Set(data.remainingOrder);
                rest.push(...baseTiles.filter(t => !lockedIds.has(t.id) && !remainingSet.has(t.id)));
              } else {
                rest = shuffleArray(rest, newSeed);
              }

              const lockedFirst = [];
              (data.lockedGroups || []).forEach(g => {
                g.items.forEach(id => {
                  const f = baseTiles.find(t => t.id === id);
                  if (f) lockedFirst.push(f);
                });
              });

              setTiles([...lockedFirst, ...rest]);
              return;
            }
          } catch {}
        }

        setSelected([]);
        setMistakes(0);
        setLockedGroups([]);
        setGuesses([]);
        setTiles(shuffleArray(baseTiles, newSeed));
      }, [dayIndex, practiceMode, showPreview]);

      // Save progress
      React.useEffect(() => {
        if (practiceMode || showPreview) return;
        const isToday = (dayIndex === getDayIndex());
        if (!isToday) return;

        const lockedIds = new Set(lockedGroups.flatMap(g => g.items));
        const remainingOrder = tiles.filter(t => !lockedIds.has(t.id)).map(t => t.id);

        const payload = {
          puzzleId: PUZZLES[dayIndex].id,
          mistakes,
          lockedGroups,
          guesses,
          remainingOrder
        };
        localStorage.setItem(progressKey, JSON.stringify(payload));

        const gameWon = lockedGroups.length === 4;
        const gameOver = mistakes >= 4 && !gameWon;
        if (gameWon || gameOver) {
          localStorage.setItem(finishedKey, "1");
        }
      }, [mistakes, lockedGroups, guesses, tiles, practiceMode, dayIndex, showPreview]);

      const finishedToday = !practiceMode && localStorage.getItem(finishedKey) === "1";
      const gameWon = lockedGroups.length === 4;
      const gameOver = mistakes >= 4 && !gameWon;
      const blockPlay = (!practiceMode && dayIndex !== getDayIndex()) || finishedToday;

      function toggleSelect(id) {
        if (gameWon || gameOver || finishedToday || showPreview) return;
        setSelected(sel =>
          sel.includes(id) ? sel.filter(s => s !== id) : sel.length < 4 ? [...sel, id] : sel
        );
      }

      function submitGuess() {
        if (selected.length !== 4 || gameWon || gameOver || finishedToday || showPreview) return;
        const groupNames = new Set(selected.map(id => baseTiles.find(t => t.id === id).group));
        if (groupNames.size === 1) {
          const groupName = [...groupNames][0];
          const color = baseTiles.find(t => t.group === groupName).color;
          setLockedGroups([...lockedGroups, { name: groupName, color, items: selected }]);
          setTiles([...lockedGroups.flatMap(g => g.items), ...tiles.filter(t => !selected.includes(t.id))]);
          setSelected([]);
        } else {
          setMistakes(m => m + 1);
          setSelected([]);
        }
      }

      if (showPreview) {
        return <PreviewPage onStart={() => setShowPreview(false)} />;
      }

      return (
        <div className="bg-white shadow-lg rounded-xl p-5 w-full">
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl font-bold">Foodle</h1>
            <button
              className="text-sm text-blue-500 hover:underline"
              onClick={() => setShowPreview(true)}
            >
              How to Play
            </button>
          </div>
          <p className="text-sm text-gray-600 mb-4">
            Group the foods into 4 correct categories. Select 4 items and press Submit.
            Example: ‚ÄúChicken, Eggs, Tofu, Tuna‚Äù ‚Üí High Protein Foods.
          </p>
          {finishedToday && (
            <div className="mb-3 rounded-xl border bg-amber-50 text-amber-900 p-3 text-sm">
              You‚Äôve completed today‚Äôs puzzle. Come back tomorrow!
            </div>
          )}
          <div className="grid grid-cols-4 gap-2 mb-4">
            {tiles.map(t => {
              const isLocked = lockedGroups.some(g => g.items.includes(t.id));
              const isSelected = selected.includes(t.id);
              return (
                <button
                  key={t.id}
                  className={`p-2 rounded text-sm font-medium border 
                    ${isLocked ? t.color : isSelected ? "bg-gray-300" : "bg-gray-100 hover:bg-gray-200"}`}
                  disabled={isLocked || gameWon || gameOver || blockPlay}
                  onClick={() => toggleSelect(t.id)}
                >
                  {t.text}
                </button>
              );
            })}
          </div>
          <div className="flex gap-2 mb-4">
            <button
              className="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
              onClick={submitGuess}
              disabled={selected.length !== 4 || gameWon || gameOver || blockPlay}
            >
              Submit
            </button>
            <button
              className="px-4 py-2 bg-gray-200 text-gray-700 rounded"
              onClick={() => setPracticeMode(!practiceMode)}
            >
              {practiceMode ? "Daily Mode" : "Practice Mode"}
            </button>
          </div>
          <p className="mt-3 text-sm text-gray-600">
            Mistakes: {mistakes} / 4
          </p>
          <footer className="mt-6 text-center text-gray-400 text-xs">
            ¬© 80/20 Nutrition
          </footer>
        </div>
      );
    }

    // Render
    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
